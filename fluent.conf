<source>
  	@type tcp
  	tag mobile-wiki
  	port 9999
  	<parse>
		@type json
        time_key time
        time_format %FT%T.%LZ
	</parse>
</source>

<filter **>
  	@type record_transformer
  	<record>
   		@hostname "#{ENV["HOST_HOSTNAME"]}"
    	source ${tag}
  	</record>
</filter>

<filter mobile-wiki>
  	@type record_transformer
  	<record>
   		appname "mobile-wiki"
		@message ${record["msg"]}
    	source ${tag}
  	</record>
	remove_keys $['msg']
</filter>

<filter fluent.**>
	@type record_transformer
	<record>
		@message ${record["message"]}
		appname fluentd
	</record>
	remove_keys $['message']
</filter>

<filter **>
  @type throttle
  group_key appname
  group_bucket_period_s   60
  group_bucket_limit    3000
  group_reset_rate_s      50
</filter>

<match fluent.**>
	@type elasticsearch
	host logs-prod.es.service.sjc.consul
	logstash_format true
	logstash_prefix logstash-dev-mobile-wiki
	<buffer>
		flush_thread_count 2
		flush_interval 1s
		chunk_limit_size 2M
		queue_limit_length 32
		retry_max_interval 30
		retry_forever true
	</buffer>
</match>

<match **>
	@type copy
	<store>
		@type stdout
	</store>
	<store>
		@type elasticsearch
		host logs-prod.es.service.sjc.consul
		logstash_format true
		logstash_prefix logstash-dev-mobile-wiki
		<buffer>
			flush_thread_count 2
			flush_interval 5s
			chunk_limit_size 20M
			queue_limit_length 32
			retry_max_interval 30
			retry_forever true
		</buffer>
	</store>
</match>